<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Italiano</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
        }

        #timer-container {
            position: fixed;
            top: 20px;
            right: 20px;
            text-align: center;
        }

        #timer {
            font-size: 24px;
            background-color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 5px;
        }

        #timer-expired {
            font-size: 18px;
            background-color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 800px; 
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .phrase {
            font-size: 24px;
            margin: 20px 0;
            min-height: 60px;
        }

        .button {
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            margin: 10px auto;
            transition: background-color 0.3s;
            display: block;
            width: 80%;
            max-width: 500px;
        }

        .button:hover {
            background-color: #45a049;
        }

        .button.incorrect {
            background-color: #f44336;
        }

        .button.incorrect:hover {
            background-color: #da190b;
        }

        #practice-area {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #result-buttons {
            width: 100%;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        #result-buttons .button {
            margin: 5px auto;
        }

        #result-buttons .button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        #initial-form {
            text-align: center;
        }

        input[type="number"] {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 80px;
            text-align: center;
        }
        
        label {
            font-weight: bold;
            margin-right: 5px;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="initial-form">
            <h2>Timer Italiano</h2>
            <p>Total de frases disponíveis: <span id="total-phrases">{{ total_phrases }}</span></p>
            <p>Selecione o intervalo de frases para praticar:</p>
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin: 10px 0;">
                <div>
                    <label for="start-phrase">De:</label>
                    <input type="number" id="start-phrase" min="1" max="{{ total_phrases }}" value="1">
                </div>
                <div>
                    <label for="end-phrase">Até:</label>
                    <input type="number" id="end-phrase" min="1" max="{{ total_phrases }}" value="{{ total_phrases }}">
                </div>
            </div>
            <button class="button" onclick="startPractice()">Começar</button>
        </div>

        <div id="practice-area" style="display: none;">
            <div id="timer-container">
                <div id="timer"></div>
                <div id="timer-expired" style="display: none; color: red; font-weight: bold;">Tempo esgotado</div>
            </div>
            <div id="portuguese" class="phrase"></div>
            <div id="italian" class="phrase" style="display: none;"></div>
            <button id="main-button" class="button" onclick="showAnswer()">Consegui traduzir</button>
            <div id="result-buttons" style="display: none;">
                <button class="button" onclick="markResult(1)" id="btn-correct">Pressione ou tecle espaço se a frase está correta</button>
                <button class="button incorrect" onclick="markResult(-1)" id="btn-incorrect">Pressione ou tecle N se a frase está errada</button>
            </div>
        </div>
    </div>

    <script>
        let currentPhraseId = null;
        let timerInterval = null;
        let remainingTime = 0;

        document.addEventListener('keydown', function(event) {
            // Prevent default space bar behavior
            if (event.code === 'Space') {
                event.preventDefault();
            }

            // Get elements state
            const italian = document.getElementById('italian');
            const mainButton = document.getElementById('main-button');
            const resultButtons = document.getElementById('result-buttons');
            const timerExpired = document.getElementById('timer-expired');
            const btnCorrect = document.getElementById('btn-correct');

            // If we're showing the translation button
            if (italian.style.display === 'none' && mainButton.style.display !== 'none') {
                if (event.code === 'Space') {
                    showAnswer();
                }
            }
            // If we're showing the result buttons
            else if (resultButtons.style.display !== 'none') {
                // If timer expired, only allow 'N' key
                if (timerExpired.style.display === 'block') {
                    if (event.key.toLowerCase() === 'n') {
                        markResult(-1);
                    }
                } else {
                    // Normal flow - both keys work
                    if (event.code === 'Space' && btnCorrect.style.display !== 'none') {
                        markResult(1);
                    } else if (event.key.toLowerCase() === 'n') {
                        markResult(-1);
                    }
                }
            }
        });

        function startTimer(seconds) {
            clearInterval(timerInterval);
            remainingTime = seconds;
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();

                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    handleTimerExpired();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            document.getElementById('timer').textContent = remainingTime + 's';
        }

        function startPractice() {
            const startPhrase = parseInt(document.getElementById('start-phrase').value);
            const endPhrase = parseInt(document.getElementById('end-phrase').value);

            if (startPhrase > endPhrase) {
                alert('O número inicial deve ser menor ou igual ao número final');
                return;
            }

            document.getElementById('initial-form').style.display = 'none';
            document.getElementById('practice-area').style.display = 'block';
            loadNewPhrase(startPhrase, endPhrase);
        }

        function loadNewPhrase(startPhrase, endPhrase) {
            clearInterval(timerInterval);
            
            fetch('/get_phrase', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `start_phrase=${startPhrase}&end_phrase=${endPhrase}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                currentPhraseId = data.id;
                document.getElementById('portuguese').textContent = data.portuguese;
                document.getElementById('italian').textContent = data.italian;
                document.getElementById('italian').style.display = 'none';
                document.getElementById('main-button').style.display = 'block';
                document.getElementById('result-buttons').style.display = 'none';
                document.getElementById('main-button').textContent = 'Consegui traduzir';
                
                // Enable the main button
                document.getElementById('main-button').disabled = false;
                
                startTimer(data.timer);
            });
        }

        function handleTimerExpired() {
            document.getElementById('timer-expired').style.display = 'block';
            document.getElementById('italian').style.display = 'block';
            document.getElementById('main-button').style.display = 'none';
            document.getElementById('result-buttons').style.display = 'block';
            
            // Hide the "correct" button when timer expires
            document.getElementById('btn-correct').style.display = 'none';
            document.getElementById('btn-incorrect').disabled = false;
        }

        function showAnswer() {
            clearInterval(timerInterval);
            document.getElementById('italian').style.display = 'block';
            document.getElementById('main-button').style.display = 'none';
            document.getElementById('result-buttons').style.display = 'block';
            
            // Make sure buttons are enabled and visible
            document.getElementById('btn-correct').style.display = 'block';
            document.getElementById('btn-incorrect').style.display = 'block';
            document.getElementById('btn-correct').disabled = false;
            document.getElementById('btn-incorrect').disabled = false;
        }

        function markResult(scoreChange) {
            // Prevent double submissions
            if (document.getElementById('btn-incorrect').disabled) {
                return;
            }

            // Hide timer expired message if showing
            document.getElementById('timer-expired').style.display = 'none';

            // Disable both buttons
            document.getElementById('btn-correct').disabled = true;
            document.getElementById('btn-incorrect').disabled = true;

            fetch('/update_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: currentPhraseId,
                    scoreChange: scoreChange
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(() => {
                const startPhrase = document.getElementById('start-phrase').value;
                const endPhrase = document.getElementById('end-phrase').value;
                loadNewPhrase(startPhrase, endPhrase);
            })
            .catch(error => {
                console.error('Error:', error);
                // Re-enable buttons on error
                document.getElementById('btn-correct').disabled = false;
                document.getElementById('btn-incorrect').disabled = false;
            });
        }
    </script>
</body>
</html>
